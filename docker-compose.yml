# =============================================================================
# AIOps Platform - Docker Compose
# =============================================================================
# Быстрый старт:
#   make setup && make up
#   или: docker compose up -d
#
# С локальной LLM (Ollama):
#   docker compose --profile ollama up -d
#
# С n8n автоматизацией:
#   docker compose --profile n8n up -d
#
# Полная установка (с Milvus, Ollama, n8n):
#   docker compose --profile full up -d
# =============================================================================

services:
  # ===========================================================================
  # CORE SERVICES
  # ===========================================================================
  
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    container_name: aiops-api
    restart: unless-stopped
    ports:
      - "${API_PORT:-8000}:8000"
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - PROMETHEUS_URL=http://prometheus:9090
      - ALERTMANAGER_URL=http://alertmanager:9093
      - OLLAMA_HOST=http://ollama:11434
      - N8N_URL=http://n8n:5678
      - N8N_WEBHOOK_SECRET=${N8N_WEBHOOK_SECRET:-aiops-webhook-secret}
    volumes:
      - ./playbooks:/app/playbooks:ro
      - ./config:/app/config:ro
      - api-logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    networks:
      - aiops-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  bot:
    build:
      context: .
      dockerfile: Dockerfile
      target: bot
    container_name: aiops-bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - API_URL=http://api:8000
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - bot-logs:/app/logs
    depends_on:
      api:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - aiops-network

  # ===========================================================================
  # DATA STORES
  # ===========================================================================

  redis:
    image: redis:7-alpine
    container_name: aiops-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - aiops-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: aiops-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - cluster.name=aiops-cluster
    ports:
      - "${ES_PORT:-9200}:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - aiops-network
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ===========================================================================
  # MONITORING
  # ===========================================================================

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: aiops-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    networks:
      - aiops-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: aiops-alertmanager
    restart: unless-stopped
    ports:
      - "${ALERTMANAGER_PORT:-9093}:9093"
    volumes:
      - ./config/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - aiops-network
    depends_on:
      - api

  grafana:
    image: grafana/grafana:10.2.0
    container_name: aiops-grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - aiops-network
    depends_on:
      - prometheus

  # ===========================================================================
  # AUTOMATION - n8n (Optional - запуск с --profile n8n или --profile full)
  # ===========================================================================

  n8n:
    image: n8nio/n8n:latest
    container_name: aiops-n8n
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - NODE_ENV=production
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-http://localhost:5678/}
      - GENERIC_TIMEZONE=${TZ:-Europe/Moscow}
      # Безопасность
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH:-true}
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-aiops123}
      # Интеграция с AIOps
      - AIOPS_API_URL=http://api:8000
      - AIOPS_WEBHOOK_SECRET=${N8N_WEBHOOK_SECRET:-aiops-webhook-secret}
    volumes:
      - n8n-data:/home/node/.n8n
      - ./config/n8n:/home/node/n8n-config:ro
    networks:
      - aiops-network
    profiles:
      - n8n
      - full
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================================================
  # AI/LLM - Ollama (Optional - запуск с --profile ollama)
  # ===========================================================================

  ollama:
    image: ollama/ollama:latest
    container_name: aiops-ollama
    restart: unless-stopped
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - aiops-network
    profiles:
      - ollama
      - full
    # GPU support (uncomment if you have NVIDIA GPU)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # VECTOR DATABASE - Milvus (Optional - запуск с --profile full)
  # ===========================================================================

  milvus:
    image: milvusdb/milvus:v2.3.3-standalone
    container_name: aiops-milvus
    restart: unless-stopped
    ports:
      - "${MILVUS_PORT:-19530}:19530"
    volumes:
      - milvus-data:/var/lib/milvus
    environment:
      - ETCD_USE_EMBED=true
      - ETCD_DATA_DIR=/var/lib/milvus/etcd
    networks:
      - aiops-network
    profiles:
      - full

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  aiops-network:
    driver: bridge
    name: aiops-network

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  redis-data:
    name: aiops-redis-data
  es-data:
    name: aiops-es-data
  prometheus-data:
    name: aiops-prometheus-data
  alertmanager-data:
    name: aiops-alertmanager-data
  grafana-data:
    name: aiops-grafana-data
  ollama-data:
    name: aiops-ollama-data
  milvus-data:
    name: aiops-milvus-data
  n8n-data:
    name: aiops-n8n-data
  api-logs:
    name: aiops-api-logs
  bot-logs:
    name: aiops-bot-logs
